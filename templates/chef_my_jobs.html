{% load static %}
{% include 'header.html' %}

<head>
  <title>My Job Applications | chefs.com.ng</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    .bodyy {
      background: linear-gradient(to bottom right, grey, #182848);
      padding-top: 10rem !important;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .contjob {
      margin-top: 3rem !important;
    }

    .contjobs {
      padding-block: 1rem !important;
    }

    .card {
      border-radius: 1rem;
      overflow: hidden;
    }

    h3 {
      text-align: center;
      font-weight: bold;
      color: black;
      text-shadow: 1px 1px 2px black;
    }

    table {
      border-radius: 10px;
      overflow: hidden;
    }

    th {
      background: #222;
      color: white;
    }

    tr:hover {
      background: #f1f1f1;
    }

    .testimony-section {
      margin-top: 1rem;
      background: rgba(0,0,0,0.5);
      border-radius: 10px;
      padding: 1rem;
      color: #fff;
    }

    .testimony-section textarea {
      resize: none;
    }

    .pnote {
      color: yellow;
    }
  </style>
</head>

<body class="bodyy">

  <!-- Loader -->
  <div id="preloader">
    <div id="status">
      <div class="spinner">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
    </div>
  </div>
  <!-- Loader -->

  <div class="container mt-5">
    <div class="card shadow-lg border-0 contjob">
      <div class="card-body contjobs">
        <h3 class="mb-4">üßæ My Job Applications</h3>

        {% if job_applications %}
        <div class="table-responsive">
          <table class="table table-striped align-middle">
            <thead>
              <tr class="text-center">
                <th>Employer</th>
                <th>Job / Request</th>
                <th>Message</th>
                <th>Status</th>
                <th>Date Applied</th>
              </tr>
            </thead>

            <tbody class="text-center">
              {% for app in job_applications %}
              <tr>
                <!-- Employer Column -->
                <td>{{ app.employer_name }}</td>

                <!-- Job / Request Column -->
                <td>
                  {% if app.job_title %}
                    {{ app.job_title }}
                  {% elif app.request_type %}
                    {% for pos in app.request_type %}
                      {{ pos|title }}{% if not forloop.last %}, {% endif %}
                    {% endfor %}
                  {% else %}
                    N/A
                  {% endif %}
                </td>

                <!-- Message Column -->
                <td>{{ app.message|default:"‚Äî" }}</td>

                <!-- Status Column -->
                <td>
                  {% if app.status == "Pending" %}
                    <span class="badge bg-warning text-dark">Pending</span>
                  {% elif app.status == "Accepted" %}
                    <span class="badge bg-success">Accepted</span>
                  {% elif app.status == "Rejected" %}
                    <span class="badge bg-danger">Rejected</span>
                  {% elif app.status in "Hired,Completed,Engaged" %}
                    <span class="badge bg-info text-dark">{{ app.status|capfirst }}</span>
                  {% endif %}
                </td>

                <!-- Date Applied Column -->
                <td>{{ app.applied_date|date:"M d, Y" }}</td>
              </tr>

              {% if app.status == "Hired" %}
              <tr>
                <td colspan="5">
                  <div class="testimony-section">

                    {% if not app.chef_testimony %}
                      <p class="pnote">
                        üìù You must submit a testimony within <strong>7 days</strong>
                        or your account will be restricted.
                      </p>

                      <textarea class="form-control testimony-input" rows="3"
                        placeholder="Write your testimony, not less than 50 words."></textarea>

                      <button class="btn btn-primary btn-sm mt-2 submit-testimony-btn"
                        data-id="{{ app.id }}">Submit Testimony</button>

                    {% else %}
                      <div class="alert alert-success mt-2 mb-0">
                        <strong>‚úÖ Your testimony:</strong><br>
                        <em>{{ app.chef_testimony }}</em>
                      </div>
                    {% endif %}

                  </div>
                </td>
              </tr>
              {% endif %}

              {% endfor %}
            </tbody>
          </table>
        </div>

        {% else %}
        <div class="alert alert-info text-center mt-3">
          You haven‚Äôt applied for any jobs yet.
        </div>
        {% endif %}

        <div class="text-center mt-4">
          <a href="{% url 'chef_dashboard' %}" class="btn btn-secondary">‚¨Ö Back to Dashboard</a>
        </div>
      </div>
    </div>
  </div>

  <!-- FIXED WORKING SCRIPT -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

 <script>
$(document).ready(function(){

    $(".submit-testimony-btn").click(function(){

        const btn = $(this);
        const id = btn.data("id");
        const section = btn.closest(".testimony-section");
        const textarea = section.find(".testimony-input");
        const testimony = textarea.val().trim();

        // --- WORD COUNT CHECK ---
        const wordCount = testimony.split(/\s+/).filter(w => w.length > 0).length;

        if(wordCount < 50){
            alert(`Your testimony must be at least 50 words. Currently: ${wordCount} words.`);
            return;
        }

        if(!testimony){
            alert("Please write your testimony before submitting.");
            return;
        }

        fetch(`/application/${id}/submit_testimonyy/`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ testimony })
        })
        .then(res => res.json())
        .then(data => {
            if(data.success){

                // Replace entire section with success message
                section.html(`
                    <div class="alert alert-success mt-2 mb-0">
                        <strong>‚úÖ Your testimony:</strong><br>
                        <em>${testimony}</em>
                    </div>
                `);

            } else {
                alert(data.message || "Error submitting testimony.");
            }
        })
        .catch(() => alert("Error submitting testimony. Please try again."));
    });

});
</script>


  {% include 'footer.html' %}
</body>
