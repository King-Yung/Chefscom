<!DOCTYPE html>

{% include 'header.html' %}
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Chefs | Chefs.com</title>

  <style>
    .fullname { font-size: 1.6rem !important; }
  </style>
</head>

<body class="bodyi">
  <div id="preloader">
    <div id="status">
      <div class="spinner">
        <div class="double-bounce1"></div>
        <div class="double-bounce2"></div>
      </div>
    </div>
  </div>

  <div class="container py-5 dash">
    <a href="javascript:history.back()" class="btn btn-primary btnback mb-3">‚Üê Back</a>
    <div class="card shadow-lg border-0 rounded-4 p-4">

      <h3 class="mb-4 text-center">üë®‚Äçüç≥ Manage Engaged Chefs</h3>

      {% if engagements %}
        <div class="list-group text-start">
          {% for e in engagements %}
            <div class="list-group-item mb-3 rounded-3 shadow-sm p-3" id="engagement-{{ e.id }}">
              
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong class="fullname">{{ e.employer_organization }}</strong><br>
                  <small class="text-muted">{{ e.message }}</small><br>
                  <span class="badge 
                    {% if e.status == 'pending' %}bg-warning text-dark
                    {% elif e.status == 'accepted' %}bg-success
                    {% elif e.status == 'rejected' %}bg-danger
                    {% elif e.status == 'engaged' %}bg-info text-dark{% endif %}">
                    {{ e.status|capfirst }}
                  </span>
                </div>
              </div>

              {% if e.status == 'accepted' or e.status == 'engaged' %}

              <div class="mt-3 ps-3 border-start border-3 border-success">
                <p class="mb-1"><strong>Email:</strong> {{ e.candidate_email }}</p>
                <p class="mb-1"><strong>Phone:</strong> {{ e.candidate_phone }}</p>
                <p class="mb-1"><strong>Country:</strong> {{ e.candidate_country }}</p>
                <p><span style="color: red; font-weight: bold; font-style: italic;">Note:</span>
                  only click <strong>Hire</strong> after successful negotiation.
                </p>
              </div>
              {% endif %}

              <div class="mt-3 text-end">
                {% if e.status == 'accepted' %}
                  <button class="btn btn-sm btn-outline-success engage-btn" data-id="{{ e.id }}">Hire</button>
                {% elif e.status == 'engaged' %}
                  <button class="btn btn-sm btn-success" disabled>Hired</button>

                  {% if not e.employer_testimony %}
                  <div class="mt-3 text-start testimony-section" id="testimony-section-{{ e.id }}">
                    <label for="testimony-{{ e.id }}" class="form-label">
                      Leave a testimony within 7 days to avoid account restrictions
                    </label>
                    <textarea id="testimony-{{ e.id }}" class="form-control testimony-input" rows="3" 
                      placeholder="Write your testimony, maximum 50 words" data-id="{{ e.id }}"></textarea>
                    <button class="btn btn-sm btn-primary mt-2 submit-testimony" data-id="{{ e.id }}">Submit Testimony</button>
                  </div>
                  {% else %}
                  <div class="alert alert-success mt-3">
                    <strong>‚úÖ Testimony submitted:</strong><br>
                    <em>{{ e.employer_testimony }}</em>
                  </div>
                  {% endif %}
                {% endif %}

                {% if not e.employer_testimony %}
                  <button class="btn btn-sm btn-outline-danger delete-engagement" data-id="{{ e.id }}">Delete</button>
                {% endif %}
              </div>

            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="alert alert-info">No engagements yet.</div>
      {% endif %}

    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
$(document).ready(function() {
  // Delete engagement
  $(".delete-engagement").click(function() {
    const id = $(this).data("id");
    const card = $(this).closest(".list-group-item");
    if (confirm("Are you sure you want to delete this engagement?")) {
      $.ajax({
        url: `/engagement/${id}/delete/`,
        type: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        success: function() { card.fadeOut(400, () => card.remove()); },
        error: function() { alert("Error deleting engagement."); }
      });
    }
  });

  // Engage candidate
  $(".engage-btn").click(function() {
    const id = $(this).data("id");
    const button = $(this);
    if (confirm("Hire this candidate?")) {
      $.ajax({
        url: `/engagement/${id}/engage/`,
        type: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
        success: function(response) {
          if(response.success){
            button.text("Hired").prop("disabled", true)
              .removeClass("btn-outline-success").addClass("btn-success");
            button.closest(".list-group-item")
              .find(".badge")
              .removeClass("bg-success bg-warning bg-danger")
              .addClass("bg-info text-dark")
              .text("Engaged");
            alert("‚úÖ Candidate hired successfully.");
            location.reload();
          } else { alert(response.message || "Something went wrong."); }
        },
        error: function() { alert("Error hiring candidate."); }
      });
    }
  });

  // Submit Testimony with 50-word max
  $(".submit-testimony").click(function() {
    const id = $(this).data("id");
    const textarea = $(`#testimony-${id}`);
    const testimony = textarea.val().trim();

    if (!testimony) { 
      alert("Please write your testimony."); 
      return; 
    }

    const wordCount = testimony.split(/\s+/).filter(w => w.length > 0).length;
    if (wordCount > 50) {
      alert(`Your testimony is too long. Maximum allowed is 50 words (currently ${wordCount}).`);
      return;
    }

    $.ajax({
      url: `/engagement/${id}/testimony/`,
      type: "POST",
      headers: { "X-CSRFToken": "{{ csrf_token }}" },
      data: JSON.stringify({ testimony: testimony }),
      contentType: "application/json",
      success: function(response) {
        if(response.success){ 
          alert("‚úÖ Testimony submitted successfully."); 
          location.reload(); 
        } else { 
          alert(response.message || "Failed to submit testimony."); 
        }
      },
      error: function() { alert("Error submitting testimony."); }
    });
  });
});
  </script>

  {% include 'footer.html' %}
</body>
</html>
